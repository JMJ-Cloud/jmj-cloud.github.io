---
// GoogleAnalytics.astro
// Google Analytics 4 component
// Only loads after user grants cookie consent
const gaId = import.meta.env.PUBLIC_GA_ID;
---

{gaId && (
  <script define:vars={{ gaId }}>
    function loadGoogleAnalytics() {
      // Prevent double-loading
      if (window.gtag) return;

      // Load gtag.js script
      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${gaId}`;
      document.head.appendChild(script);

      // Initialize gtag
      window.dataLayer = window.dataLayer || [];
      window.gtag = function() { dataLayer.push(arguments); };
      gtag('js', new Date());
      gtag('config', gaId);
    }

    // Listen for consent event
    window.addEventListener('clarity-consent-granted', loadGoogleAnalytics);

    // Check if consent was already granted (handles page refreshes)
    if (localStorage.getItem('clarity-consent') === 'true') {
      loadGoogleAnalytics();
    }
  </script>
)}
